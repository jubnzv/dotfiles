#!/usr/bin/env bash
#
# Send desktop notification with number of remaning tasks for today.
#
if [[ ! -x "$(command -v notify-send)" ]]; then
    echo "notify-send: command not found"
    exit 1
fi
if [[ ! -x "$(command -v task)" ]]; then
    echo "task: command not found"
    exit 1
fi

# Show notification even if there are no tasks.
if [[ $1 == "-v" ]]; then
    verbose=1
else
    verbose=0
fi

sched_num="$(task rc.gc=off sched.before:eod status:pending -COMPLETED -DELETED -DUETODAY count 2>/dev/null)"
sched_num=$(($sched_num))
due_num="$(task rc.gc=off due.before:eod status:pending -COMPLETED -DELETED count 2>/dev/null)"
due_num=$(($due_num))
overdue_num="$(task rc.gc=off status:pending +OVERDUE -DELETED count 2>/dev/null)"
overdue_num=$(($overdue_num))

tasks_num=$(($sched_num+$due_num+$overdue_num))
if [[ $tasks_num -gt 0 ]]; then
    msg="("
    if [[ $sched_num -gt 0 ]]; then
        msg=$msg"<span foreground='#fe8019'>$sched_num</span> scheduled"
    else
        msg=$msg"<span foreground='#b8bb26'>0</span> scheduled"
    fi
    msg=$msg", "
    if [[ $due_num -gt 0 ]]; then
        msg=$msg"<span foreground='#fb4934'>$due_num</span> due"
    else
        msg=$msg"<span foreground='#b8bb26'>0</span> due"
    fi
    if [[ $overdue_num -gt 0 ]]; then
        msg=$msg", <span foreground='#cc241d'>$overdue_num</span> overdue"
    fi
    msg=$msg")"

    notify-send -i $(realpath ~/.icon/taskwarrior.png) \
        "taskwarrior" "There are $tasks_num pending tasks for today $msg"
elif [[ $verbose == 1 ]]; then
    notify-send -i $(realpath ~/.icon/taskwarrior.png) \
        "taskwarrior" "There are no tasks!"
fi

