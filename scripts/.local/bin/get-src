#!/bin/bash
#
# Script to download and tag source code.
# Requirements:
# + Debian-based distro
# + git
# + tmsu (https://github.com/oniony/TMSU/)
#
set -euo pipefail

print_usage() {
    echo "Usage: $0 <apt|git> <package|repo> [tmsu tags]"
    echo "Examples:"
    echo "$0 apt htop lang='c' system"
    echo "$0 git jubnvz/dotfiles dotfiles"
    echo "$0 git https://github.com/oniony/TMSU lang='go' packages"
}

if (( $# < 2 )); then
    print_usage
    exit 1
fi

if [[ $1 != "apt" ]] && [[ $1 != "git" ]]; then
    print_usage
    exit 1
fi

if [[ ! -x "$(command -v tmsu)" ]]; then
    echo "tmsu: command not found"
    exit 1
fi
if [[ ! -x "$(command -v git)" ]]; then
    echo "git: command not found"
    exit 1
fi
if [[ ! -x "$(command -v apt-get)" ]]; then
    echo "apt-get: command not found"
    exit 1
fi

wget -q --spider http://google.com
if [ ! $? -eq 0 ]; then
    echo "Please connect to the internet before continuing."
    exit 1
fi

method=$1
package=$2
tmsu_args=${@:3}

# Directory to save sources
target_path=""

pushd ~/Sources >/dev/null | /bin/true

if [ $method == "apt" ]; then
    target_path=$package
    if [ -d $target_path ]; then
        echo "Directory $target_path exists! Bailing out."
        exit 1
    fi

    apt-get source $package
    mv $package-* $target_path

elif [ $method == "git" ]; then
    target_path=$(echo $2 | awk -F'/' '{ print $NF }')
    if [ -d $target_path ]; then
        echo "Directory $target_path exists! Bailing out."
        exit 1
    fi

    # Full URL
    if [[ $package =~ ^http.* ]]; then
        git clone $package $target_path
    # Github URL
    elif [[ $package =~ ^.*\/.*$ ]]; then
        git clone https://github.com/$package $target_path
    else
        echo "Unknown package type: $package"
        exit 1
    fi
fi

# Apply the tags
tmsu tag $target_path $tmsu_args

popd >/dev/null | /bin/true
