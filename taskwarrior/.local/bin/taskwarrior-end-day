#!/usr/bin/env bash
#
# Postpone remaining tasks to tomorrow and send notification with short summary
# of this day.
#
if [[ ! -x "$(command -v task)" ]]; then
    echo "task: command not found"
    exit 1
fi
if [[ ! -x "$(command -v zenity)" ]]; then
    echo "zenity: command not found"
    exit 1
fi

# Request user confirmation.
if [[ ! $1 == "-f" ]]; then
    zenity --question --title="Finish this day" --text="Are you sure?"
    if [ ! $? = 0 ]; then
        exit 0
    fi
fi

# Stop all active tasks.
task rc.gc=off +ACTIVE _ids | xargs task rc.gc=off rc.confirmation=no rc.bulk=yes stop

# Postpone scheduled remaining tasks to tomorrow.
sched_msg=""
sched_ids="$(task rc.gc=off sched:today _ids)"
if [[ ! $sched_ids == "" ]]; then
    sched_count=0
    IFS=$'\n'
    for i in ${sched_ids}; do
        task $i m sched:+1d
        ((sched_count++))
    done
    if [[ $sched_count -ne 0 ]]; then
        sched_msg=" <span foreground='#fe8019'>$sched_count</span> tasks has been postponed."
    fi
fi

# Synchrnonize with taskserver.
# task sync
# if [ ! $? -eq 0 ]; then
#     notify-send -i $(realpath ~/.icon/taskwarrior.png) \
#         "taskwarrior" "Can't sync with taskserver!"
#     exit 1
# fi

# Count tasks completed today.
completed_tasks="$(task end:today status:completed all rc.gc=off 2>/dev/null | egrep '[0-9]\ tasks$' | cut -d ' ' -f -1)"
if [[ $completed_tasks == "" ]]; then
    completed_tasks=0
fi

# Are there any non-finished due tasks?
due_msg=""
due_tasks="$(task due:today status:pending all rc.gc=off 2>/dev/null | egrep '[0-9]\ task$' | cut -d ' ' -f -1)"
if [[ ! $due_tasks == "" ]]; then
    due_msg=" <span foreground='#fb4934'>${due_tasks}</span> tasks are overdue."
fi

notify-send -i $(realpath ~/.icon/taskwarrior.png) \
    "taskwarrior" "Completed: <span foreground='#b8bb26'>$completed_tasks</span> tasks.${sched_msg}${due_msg}"
